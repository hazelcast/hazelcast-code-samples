name: Builder

on:
  push:
    branches:
      - "master"
  pull_request:

jobs:
  check_for_membership:
    runs-on: ubuntu-latest
    name: Check membership of given user
    outputs:
      check-result: ${{ steps.composite.outputs.check-result }}

    steps:
      - name: Action for membership check
        id: composite
        uses: hazelcast/hazelcast-tpm/membership@main
        with:
          organization-name: 'hazelcast'
          member-name: ${{ github.event.pull_request.head.repo.owner.login }}
          token: ${{ secrets.GITHUB_TOKEN }}
  build:
    needs: [check_for_membership]
    if: needs.check_for_membership.outputs.check-result == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Detect untrusted community PR
        if: ${{ needs.check_for_membership.outputs.check-result == 'false' }}
        run: |
          gh pr comment ${{ github.event.number }} \
            --body "ðŸ‘½ Untrusted non Hazelcast PR, \`${GITHUB_JOB}\` must be [run manually](${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID})."
          exit 1
        env:
          GH_TOKEN: ${{ inputs.GITHUB_TOKEN }}
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
      - name: Build and test
        env:
            HAZELCAST_ENTERPRISE_KEY: ${{ secrets.HAZELCAST_ENTERPRISE_KEY_V7 }}
        run: |
          set -x
          mvn --version --batch-mode --no-transfer-progress --quiet clean package -DskipTests
